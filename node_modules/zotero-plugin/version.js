"use strict";
/* eslint-disable no-console */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fs = tslib_1.__importStar(require("fs"));
const os = tslib_1.__importStar(require("os"));
const path = tslib_1.__importStar(require("path"));
const continuous_integration_1 = require("./continuous-integration");
const root_1 = tslib_1.__importDefault(require("./root"));
let version = null;
function load(vpath) {
    return JSON.parse(fs.readFileSync(vpath, 'utf-8')).version;
}
const version_json = path.join(root_1.default, 'gen/version.json');
if (fs.existsSync(version_json)) {
    version = load(version_json);
}
else {
    console.log('writing version');
    version = load(path.join(root_1.default, 'package.json'));
    if (continuous_integration_1.ContinuousIntegration.service && !continuous_integration_1.ContinuousIntegration.tag) {
        const issue = continuous_integration_1.ContinuousIntegration.issue && process.env.VERSION_WITH_ISSUE !== 'false' ? `.${continuous_integration_1.ContinuousIntegration.issue}` : '';
        version = `${version}${issue}.${continuous_integration_1.ContinuousIntegration.build_number}`;
    }
    else if (!continuous_integration_1.ContinuousIntegration.service) {
        version = `${version}.${os.userInfo().username}.${os.hostname()}`;
    }
    if (!fs.existsSync(path.dirname(version_json)))
        fs.mkdirSync(path.dirname(version_json));
    fs.writeFileSync(version_json, JSON.stringify({ version }));
}
exports.default = version;
